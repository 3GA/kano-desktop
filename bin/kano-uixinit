#!/bin/bash

# kano-uixinit
#
# Copyright (C) 2014 Kano Computing Ltd.
# License: http://www.gnu.org/licenses/gpl-2.0.txt GNU General Public License v2
#
#  This script is a wrapper on top of LXDE autoinit.
#
#  It starts kano-settings if needed and sets the background wallpaper
#  It fits well on bootup and logoff-logon transitions.
#

. /usr/share/kano-toolset/logging.sh

LAUNCH_START=0
LAUNCH_WIFI_CONFIG=1
LAUNCH_UPDATER=2
LAUNCH_SETTINGS=3
LAUNCH_PROFILE=5
LAUNCH_SWAG=6
LAUNCH_KEYBOARD=7

first_boot_file="$HOME/.kano-settings/first_boot"
second_boot_file="$HOME/.kano-settings/second_boot"
after_update_file="$HOME/.kano-settings/after_update"
mkdir -p "$HOME/.kano-settings"

function is_installed
{
    if [ -n "`which $1`" ]; then
        return 0
    else
        return 1
    fi
}

function first_boot_part_1
{
    # 1: Keyboard tutorial
    if [ "$1" == "True" ]; then
        kano-tutorial
    fi
    # load background
    /usr/bin/kdesk -w &

    # Launch init flow from the beginning
    sudo kano-init-flow $LAUNCH_START
    EXIT_CODE=$?

    while [ $EXIT_CODE -le $LAUNCH_UPDATER ]; do

        if [ $EXIT_CODE -eq $LAUNCH_WIFI_CONFIG ]; then
            rxvt -title \'WiFi\' -e sudo /usr/bin/kano-wifi
            # Check for internet
            /usr/bin/is_internet
            rc=$?
            if [ "$rc" -eq "0" ]; then
                sudo kano-init-flow $LAUNCH_UPDATER
                EXIT_CODE=$?
            else
                # Launch again internet screen
                sudo kano-init-flow $LAUNCH_WIFI_CONFIG
                EXIT_CODE=$?
            fi
        fi

        if [ $EXIT_CODE -eq $LAUNCH_UPDATER ]; then
           sudo kano-updater -n
           # Create after update file to make sure we don't go through it again
           touch $after_update_file
           sudo kano-init-flow $LAUNCH_SETTINGS
           EXIT_CODE=$?
        fi

        # If you close window, stops application crashing
        if [ $EXIT_CODE -eq 0 ]; then
           exit $?
        fi

    done
}

function first_boot_part_2
{
    # load background
    /usr/bin/kdesk -w &
    # Launch login screen
    kano-login first_boot
    sudo kano-init-flow $LAUNCH_SWAG
    logger_info "Playing os_intro.mkv"
    kano-video-cli /usr/share/kano-media/videos/os_intro.mkv
}

# detect kano-keyboard
kano_keyboard=`python -c "from kano.utils import detect_kano_keyboard; print detect_kano_keyboard()"`

check_for_updates=1

# The following block is related to the first bootflow
if [ ! -f $first_boot_file ] && [ ! -f /boot/skip ]; then

    if [ ! -f $second_boot_file ]; then
        # First part
        if [ -f $after_update_file ]; then
            # Resuming first boot
            logger_info "Launching kano-init-flow after update"
            sudo kano-init-flow $LAUNCH_SETTINGS
        else
            # first boot
            logger_info "Launching kano-init-flow first part"
            first_boot_part_1 $kano_keyboard
        fi
        logger_debug "Marking kano-init-flow rebooting"
        touch $second_boot_file
        rm $after_update_file
        sudo reboot
    else
        # second boot reboot
        logger_info "Launching kano-init-flow second part"
        first_boot_part_2
        logger_debug "Marking kano-init-flow completed"
        rm $second_boot_file
        touch $first_boot_file
        check_for_updates=0
    fi
else
    # load background
    /usr/bin/kdesk -w &
fi

# startmouse
logger_info "Launching startmouse"
/usr/bin/startmouse &

# Load Kano Keyboard configuration file for Hotkeys, or a generic one for regular keyboards
keyboard_conf_dir="/usr/share/kano-desktop/config/keyboard"
if [ "$kano_keyboard" = "True" ]; then
    keyboard_conf="$keyboard_conf_dir/kanokeyboardrc"
else
    keyboard_conf="$keyboard_conf_dir/generickeyboardrc"
fi
logger_info "Launching xbindkeys with configuration: $keyboard_conf"
/usr/bin/xbindkeys -f $keyboard_conf

# Disable XServer screen saver time and screen blanking (The display would become black)
if is_installed xset; then
    logger_info "Disabling the screensaver"
    xset s off
    xset -dpms
    xset s noblank
fi

# check for updates and display the update dialog
# restrict server communication to max once a week (168 hours)
if [ $check_for_updates -eq 1 ] && [ is_internet ]; then
    logger_info "Checking for update"
    sudo /usr/bin/check-for-updates -t 168 -d
else
    logger_info "Not checking for update"
fi

# lxpanel
logger_info "Launching LXPanel"
/usr/bin/lxpanel --profile LXDE &

# starting kdesk
logger_info "Launching kdesk"
/usr/bin/kdesk &

# Report a startup event to Kano Tracker
kano-profile-cli increment_app_runtime startup 0

# Remove Homedir "Desktop" folder created by:
# /usr/share/xsessions/lightdm-xsession.desktop
rm -rf  ~/Desktop

# starting kano-vnc
startvnc=/usr/share/kano-vnc/startvnc
if [ -e $startvnc ]; then
    logger_info "Launching startvnc"
    $startvnc
fi
