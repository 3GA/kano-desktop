#!/bin/bash

# kano-uixinit
#
# Copyright (C) 2014 Kano Computing Ltd.
# License: http://www.gnu.org/licenses/gpl-2.0.txt GNU General Public License v2
#
#  This script is a wrapper on top of LXDE autoinit.
#
#  It starts kano-settings if needed and sets the background wallpaper
#  It fits well on bootup and logoff-logon transitions.
#

. /usr/share/kano-toolset/logging.sh

LAUNCH_WIFI_CONFIG=1
LAUNCH_UPDATER=2
LAUNCH_SETTINGS=3
LAUNCH_PROFILE=5
LAUNCH_SWAG=6
LAUNCH_KEYBOARD=7

function is_installed
{
    if [ -n "`which $1`" ]; then
        return 0
    else
        return 1
    fi
}

function first_boot_part_1
{
    # 1: Keyboard tutorial
    if [ "$1" == "True" ]; then
        kano-tutorial
    else
        # No keyboard detected
        /usr/bin/kano-init-flow $LAUNCH_KEYBOARD
    fi

    # Launch init flow from the beginning
    /usr/bin/kano-init-flow 0
    EXIT_CODE=$?

    while [ $EXIT_CODE -le $LAUNCH_UPDATER ]; do

        if [ $EXIT_CODE -eq $LAUNCH_WIFI_CONFIG ]; then
            rxvt -title \'WiFi\' -e sudo /usr/bin/kano-wifi
            # Check for internet
            /usr/bin/is_internet
            rc=$?
            if [ "$rc" -eq "0" ]; then
                /usr/bin/kano-init-flow $LAUNCH_UPDATER
                EXIT_CODE=$?
            else
                # Launch again internet screen
                /usr/bin/kano-init-flow 1
                EXIT_CODE=$?
            fi
        fi

        if [ $EXIT_CODE -eq $LAUNCH_UPDATER ]; then
           sudo kano-updater -n
           /usr/bin/kano-init-flow $LAUNCH_SETTINGS
           EXIT_CODE=$?
        fi

        # If you close window, stops application crashing
        if [ $EXIT_CODE -eq 0 ]; then
           exit $?
        fi

    done
}

function first_boot_part_2
{
    kano-login first_boot
    /usr/bin/kano-init-flow $LAUNCH_SWAG
    logger_info "Playing os_intro.mkv"
    kano-video-cli -f /usr/share/kano-media/videos/os_intro.mkv
}

# load background
/usr/bin/kdesk -w &

# detect kano-keyboard
kano_keyboard=`python -c "from kano.utils import detect_kano_keyboard; print detect_kano_keyboard()"`

first_boot=0

# The following block is related to the first bootflow
if is_installed kano-profile-cli && is_installed kano-settings; then

    # DEV IMAGE: This is to skip the init-flow
    if [ -f /boot/skip ]; then
        kano-profile-cli save_app_state_variable kano-settings completed 1
        first_boot=1
    fi

    # Get the status of the init
    settings_done=`kano-profile-cli load_app_state_variable kano-settings completed`
    if [ "$settings_done" != "1" ]; then

        # After reboot
        if [ "$settings_done" == "2" ]; then
            logger_info "Launching kano-init-flow second part"
            first_boot_part_2
            logger_debug "Marking kano-init-flow completed"
            kano-profile-cli save_app_state_variable kano-settings completed 1
            first_boot=1
        # First boot
        else
            logger_info "Launching kano-init-flow first part"
            first_boot_part_1 $kano_keyboard
            logger_debug "Marking kano-init-flow rebooting"
            kano-profile-cli save_app_state_variable kano-settings completed 2
            sudo reboot
        fi
    fi
fi


# We enter the Kano UIX interface after kano-init-flow.
# It's not important if this stage has not been finalized
# it will be restarted on next bootup or logoff/logon transition

# startmouse
logger_info "Launching startmouse"
/usr/bin/startmouse &

# Load Kano Keyboard configuration file for Hotkeys, or a generic one for regular keyboards
keyboard_conf_dir="/usr/share/kano-desktop/config/keyboard"
if [ "$kano_keyboard" = "True" ]; then
    keyboard_conf="$keyboard_conf_dir/kanokeyboardrc"
else
    keyboard_conf="$keyboard_conf_dir/generickeyboardrc"
fi
logger_info "Launching xbindkeys with configuration: $keyboard_conf"
/usr/bin/xbindkeys -f $keyboard_conf

# Disable XServer screen saver time and screen blanking (The display would become black)
if is_installed xset; then
    logger_info "Disabling the screensaver"
    xset s off
    xset -dpms
    xset s noblank
fi

# check for updates and display the update dialog
# restrict server communication to max once a week (168 hours)
if [ $first_boot -eq 0 ] && [ is_internet ]; then
    logger_info "Checking for update"
    sudo /usr/bin/check-for-updates -t 168 -d
else
    logger_info "Not checking for update, internet not available"
fi

# lxpanel
logger_info "Launching LXPanel"
/usr/bin/lxpanel --profile LXDE &

# starting kdesk
logger_info "Launching kdesk"
/usr/bin/kdesk &

# Remove Homedir "Desktop" folder created by:
# /usr/share/xsessions/lightdm-xsession.desktop
rm -rf  ~/Desktop

# starting kano-vnc
startvnc=/usr/share/kano-vnc/startvnc
if [ -e $startvnc ]; then
    logger_info "Launching startvnc"
    $startvnc
fi
