#!/bin/bash
#
# kano-uixinit
#
# Copyright (C) 2014 Kano Computing Ltd.
# License: http://www.gnu.org/licenses/gpl-2.0.txt GNU General Public License v2
#
#  This script is a wrapper on top of LXDE autoinit.
#
#  It starts kano-settings if needed and sets the background wallpaper
#  It fits well on bootup and logoff-logon transitions.
#

. /usr/share/kano-toolset/logging.sh

function is_installed
{
    if [ -n "`which $1`" ]; then
        return 0
    else
        return 1
    fi
}

# load background
/usr/bin/kdesk -w &

# The following block is related to the first bootflow
if is_installed kano-profile-cli && is_installed kano-settings; then
    settings_done=`kano-profile-cli load_app_state_variable kano-settings completed`
    if [ "$settings_done" != "1" ]; then


        # settings wizard
        logger_info "Launching kano-settings"
        sudo /usr/bin/kano-settings

        # levelup dialog
        logger_debug "Marking kano-settings completed"
        kano-profile-cli save_app_state_variable kano-settings completed 1

        # first login
        registered=`kano-profile-cli is_registered`
        if [ "$registered" != "1" ]; then
            logger_info "Launching kano-login"
            /usr/bin/kano-login first_boot
        fi

        logger_info "Playing os_intro.mkv"
        kano-video-cli -f /usr/share/kano-media/videos/os_intro.mkv

    fi
fi


# We enter the Kano UIX interface after kano-settings.
# It's not important if this stage has not been finalized
# it will be restarted on next bootup or logoff/logon transition

# startmouse
logger_info "Launching startmouse"
/usr/bin/startmouse &

# Load Kano Keyboard configuration file for Hotkeys, or a generic one for regular keyboards
kano_keyboard=`python -c "from kano.utils import detect_kano_keyboard; print detect_kano_keyboard()"`
keyboard_conf_dir="/usr/share/kano-desktop/config/keyboard"
if [ "$kano_keyboard" == "True" ]; then
    keyboard_conf="$keyboard_conf_dir/kanokeyboardrc"
else
    keyboard_conf="$keyboard_conf_dir/generickeyboardrc"
fi
logger_info "Launching xbindkeys with configuration: $keyboard_conf"
/usr/bin/xbindkeys -f $keyboard_conf

# Disable XServer screen saver time and screen blanking (The display would become black)
if is_installed xset; then
    logger_info "Disabling the screensaver"
    xset s off
    xset -dpms
    xset s noblank
fi

# check for updates and display the update dialog
# restrict server communication to max once a week (168 hours)
if is_internet; then
    logger_info "Checking for update"
    sudo /usr/bin/check-for-updates -t 168 -d
else
    logger_info "Not checking for update, internet not available"
fi

# lxpanel
logger_info "Launching LXPanel"
/usr/bin/lxpanel --profile LXDE &

# starting kdesk
logger_info "Launching kdesk"
/usr/bin/kdesk &

# starting kano-vnc
startvnc=/usr/share/kano-vnc/startvnc
if [ -e $startvnc ]; then
    logger_info "Launching startvnc"
    $startvnc
fi
