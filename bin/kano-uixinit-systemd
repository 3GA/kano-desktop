#!/bin/bash

# kano-uixinit-systemd
#
# Copyright (C) 2016 Kano Computing Ltd.
# License: http://www.gnu.org/licenses/gpl-2.0.txt GNU GPL v2
#
#  This script is a wrapper on top of the Kano OS Desktop mode startup.
#  It is meant to be running under the umbrella of a systemd unit file.
#
#  It performs the following tasks:
#
#   * Announces finalisation to kano-init
#   * Sets up the Kano keyboard and hotkeys, mouse calibration
#   * Disables screen power off mode (DPMS)
#   * Triggers event processing for kano-tracker-ctl, kano-sync, kano-updater
#   * Sets up system sound volume
#
#  Logging takes place from systemd itself (journalctl).
#

logger --id --tag "info" "uixinit systemd starts"

# FIXME: is this still needed?
mkdir -p "$HOME/.kano-settings"

# Track some information about the hardware used
kano-tracker-ctl generate hw-info

# Disable XServer screen saver time and screen blanking (The display would become black)
if [ -n "`which xset`" ]; then
    xset s off
    xset -dpms
    xset s noblank
fi

# Calibrates the mouse pointer speed
/usr/bin/startmouse

# Set the initial default volume
if [ -e /etc/init.d/alsa-utils ]; then
    amixer -c 0 -- sset PCM 0 &> /dev/null
    ret_val_pcm="$?"

    amixer -c 0 -- sset Master 6 &> /dev/null
    ret_val_master="$?"

    if [ "$ret_val_pcm" -ne 0 ] || [ "$ret_val_master" -ne 0 ]; then
	logger --id --tag "warn" "Failed to set initial volume level, ret code: $ret_val"
    fi
else
    logger --id --tag "warn" "alsa-utils not found, volume not set"
fi

# TODO: move me to a systemd unit service
# Are we in Noobs ? (check for more than 2 partitions)
# If in noobs, make an xrefresh happen after 50 seconds
if [ $( lsblk -n | wc -l ) -gt 3 ] ; then
    (sleep  50; xrefresh ) &
fi

# if xrefresh is still waiting to run, stop it
kill %?xrefresh

# TODO: move me to a systemd unit service
if [ "$FIRST_BOOT" -eq 1 ]; then
    # regenerating ssh keys
    if [ `getent group kanousers | wc -l` -eq 1 ]; then
        sudo regenerate-ssh-keys &
    fi
fi

# load compositor if the new driver is running
(xdriinfo | grep vc4 ) && xcompmgr &

# LXPanel resets the volume level to 100, we need it to be restored to
# whatever level it was before shutdown or reboot
if [ -e /lib/systemd/system/alsa-restore.service ]; then
    # Redirect both stderr and stdout to null, we can do our own logging
    sudo systemctl start alsa-restore &> /dev/null
    ret_val="$?"
    if [ "$ret_val" -ne 0 ]; then
        logger --id --tag "warn" "Failed to restore volume level, ret code: $ret_val"
    else
	logger --id --tag "info" "Audio volume level was successfully restored"
    fi
else
    logger --id --tag "warn" "alsa-restore not found, cannott attempt to restore volume level"
fi

# Remove Homedir "Desktop" folder created by:
# /usr/share/xsessions/lightdm-xsession.desktop
rm -rf  ~/Desktop

logger --id --tag "info" "kano-uixinit-systemd terminated"
