#!/bin/bash

# kano-uixinit-systemd
#
# Copyright (C) 2016 Kano Computing Ltd.
# License: http://www.gnu.org/licenses/gpl-2.0.txt GNU GPL v2
#
#  This script runs each time the Kano OS Desktop mode is reached.
#  Most of the tasks have moved to /usr/bin/kano-ui-startup,
#  since the introduction of Dashboard mode and systemd units.
#
#  It performs the following tasks:
#
#   * Announces finalisation to kano-init
#   * Sets up the Kano keyboard and hotkeys, mouse calibration
#   * Disables screen power off mode (DPMS)
#   * Triggers event processing for kano-tracker-ctl, kano-sync, kano-updater
#   * Sets up system sound volume
#
#  Logging takes place from systemd itself (journalctl).
#

logger --id --tag "info" "uixinit systemd starts"

# LXPanel resets the volume level to 100, we need it to be restored to
# whatever level it was before shutdown or reboot
if [ -e /lib/systemd/system/alsa-restore.service ]; then

    # Redirect both stderr and stdout to null, we can do our own logging
    sudo systemctl start alsa-restore &> /dev/null
    ret_val="$?"
    if [ "$ret_val" -ne 0 ]; then
        logger --id --tag "warn" "Failed to restore volume level, ret code: $ret_val"
    else
	logger --id --tag "info" "Audio volume level was successfully restored"
    fi
else
    logger --id --tag "warn" "alsa-restore not found, cannott attempt to restore volume level"
fi

logger --id --tag "info" "kano-uixinit-systemd terminated"
